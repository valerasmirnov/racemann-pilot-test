<!-- üîß FIXED VERSION: correct origin handling for multiple kartodromes -->
<!-- FULL FILE ‚Äî replace index.html entirely -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>RaceMann Pilot ‚Äî RN —Ç–∞–±–ª–æ</title>
  <!-- —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <!-- ... -->
</head>
<body>
<!-- ‚õîÔ∏è HTML –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô -->
<!-- ‚õîÔ∏è –í–°–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í JS -->

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const WORKER_HOST = (qs.get("worker") || "racemann-bridge-test.vsmirnoff.workers.dev").trim();
  const AUTO_RESOLVE_INTERVAL_MS = 12000;

  const TRACKS = {
    miks:   "https://miks.racemann.com",
    lonato:"https://lonato.racemann.com",
    dozari:"https://dozari.racemann.com",
  };

  const $ = (id) => document.getElementById(id);

  let ws = null;

  // üîí SINGLE SOURCE OF TRUTH
  let currentOrigin = null;
  let currentRaceId = null;
  let currentRaceUrl = null;

  /* ===========================
     RESOLVE (FIXED)
     =========================== */

  async function resolveRaceUrlFromOrigin(origin) {
    const r = await fetch(
      `https://${WORKER_HOST}/resolve?origin=${encodeURIComponent(origin)}`,
      { cache: "no-store" }
    );
    const j = await r.json();
    if (!r.ok || !j.ok) throw new Error(j.error || "resolve failed");
    return j;
  }

  async function startAutoSwitch() {
    setInterval(async () => {
      if (!currentOrigin || !currentRaceId) return;

      try {
        const j = await resolveRaceUrlFromOrigin(currentOrigin);
        if (j.raceId && j.raceId !== currentRaceId) {
          console.log("AUTO SWITCH:", currentRaceId, "‚Üí", j.raceId);
          currentRaceId = j.raceId;
          currentRaceUrl = j.raceUrl;
          reconnectWs();
        }
      } catch (e) {
        console.warn("auto resolve failed", e);
      }
    }, AUTO_RESOLVE_INTERVAL_MS);
  }

  async function reconnectWs() {
    if (ws) ws.close();
    ws = new WebSocket(
      `wss://${WORKER_HOST}/ws?raceUrl=${encodeURIComponent(currentRaceUrl)}&dropHb=1`
    );
  }

  /* ===========================
     CONNECT BUTTON (FIXED)
     =========================== */

  async function connect() {
    const rn = $("rn").value.trim();
    if (!rn) return alert("–í–≤–µ–¥–∏—Ç–µ RN");

    const track = $("trackSelect").value;
    const input = track === "custom"
      ? $("raceInput").value.trim()
      : TRACKS[track];

    // üîí origin –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó
    currentOrigin = new URL(input.startsWith("http") ? input : "https://" + input).origin;

    const j = await resolveRaceUrlFromOrigin(currentOrigin);
    currentRaceId = j.raceId;
    currentRaceUrl = j.raceUrl;

    reconnectWs();
    startAutoSwitch();
  }

  $("btnOpen").addEventListener("click", connect);
})();
</script>
</body>
</html>
